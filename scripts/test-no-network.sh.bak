#!/bin/zsh

# Test script for --no-network feature
# Usage: ./scripts/test-no-network.sh

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test results
PASSED=0
FAILED=0
TESTS_RUN=0

# Helper functions
print_test() {
    echo ""
    echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo "${BLUE}TEST $1: $2${NC}"
    echo "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

pass() {
    echo "${GREEN}✓ PASS${NC}: $1"
    PASSED=$((PASSED + 1))
    TESTS_RUN=$((TESTS_RUN + 1))
}

fail() {
    echo "${RED}✗ FAIL${NC}: $1"
    FAILED=$((FAILED + 1))
    TESTS_RUN=$((TESTS_RUN + 1))
}

info() {
    echo "${YELLOW}ℹ INFO${NC}: $1"
}

wait_for_user() {
    echo ""
    echo "${YELLOW}⏸  Press Enter to continue...${NC}"
    read
}

# Get script directory
SCRIPT_DIR="${0:A:h}"
cd "$SCRIPT_DIR/.."

# Check prerequisites
if [ ! -f "./scripts/calf-bootstrap" ]; then
    echo "${RED}Error: calf-bootstrap not found${NC}"
    exit 1
fi

# Ensure VM is stopped at start
info "Ensuring VM is stopped..."
./scripts/calf-bootstrap --stop 2>/dev/null || true
sleep 2

# Remove network isolation marker to start fresh
rm -f ~/.calf-no-network

echo ""
echo "${BLUE}╔════════════════════════════════════════════════╗${NC}"
echo "${BLUE}║  Testing --no-network Feature                 ║${NC}"
echo "${BLUE}╔════════════════════════════════════════════════╗${NC}"
echo ""

# ============================================
# Test 1: Baseline Check
# ============================================
print_test "1" "Baseline - Network should show 'Full access'"

output=$(./scripts/calf-bootstrap --status 2>&1)
if echo "$output" | grep -q "Network: Full access"; then
    pass "Status shows 'Network: Full access'"
else
    fail "Status does not show 'Network: Full access'"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 2: Enable Network Isolation (Interactive)
# ============================================
print_test "2" "Enable Network Isolation (First Time)"

info "Running with --yes to skip confirmations"
info "You may need to enter sudo password for SUID setup"
echo ""

# Run with --yes and in background, send exit to tmux after 5 seconds
(sleep 8; echo "exit") | ./scripts/calf-bootstrap --run --no-network --yes &
BOOTSTRAP_PID=$!

# Wait for VM to be ready
sleep 10
wait $BOOTSTRAP_PID 2>/dev/null || true

# Check if marker file was created
if [ -f ~/.calf-no-network ]; then
    pass "Network isolation marker file created"
else
    fail "Network isolation marker file NOT created"
fi

# Check status
output=$(./scripts/calf-bootstrap --status 2>&1)
if echo "$output" | grep -q "Network: Isolated"; then
    pass "Status shows network isolation enabled"
else
    fail "Status does not show network isolation"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 3: Verify Internet Access Works
# ============================================
print_test "3" "Verify Internet Access (Should Work)"

vm_ip=$(tart ip calf-dev 2>/dev/null || echo "")
if [ -z "$vm_ip" ]; then
    fail "Could not get VM IP"
else
    output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
        admin@$vm_ip "curl -s -I https://google.com 2>&1 | head -n 1" 2>&1 || echo "FAILED")

    if echo "$output" | grep -q "HTTP"; then
        pass "Internet access works (got HTTP response)"
    else
        fail "Internet access failed"
        echo "Output: $output"
    fi
fi

wait_for_user

# ============================================
# Test 4: Verify Local Network is Blocked
# ============================================
print_test "4" "Verify Local Network Blocked"

output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
    admin@$vm_ip "curl -s --connect-timeout 5 http://192.168.1.1 2>&1 || echo 'BLOCKED'" 2>&1)

if echo "$output" | grep -q "BLOCKED"; then
    pass "Local network access blocked as expected"
else
    fail "Local network access NOT blocked"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 5: Verify Gateway Access Still Works (By Design)
# ============================================
print_test "5" "Verify Gateway Access (Required for NAT)"

info "Note: Softnet allows gateway access (192.168.64.1) for NAT to work"
info "This is correct behavior - it blocks OTHER local network devices"

output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
    admin@$vm_ip "ping -c 1 -W 2 192.168.64.1 >/dev/null 2>&1 && echo 'CAN_REACH' || echo 'BLOCKED'" 2>&1)

if echo "$output" | grep -q "CAN_REACH"; then
    pass "Gateway accessible (correct - needed for NAT)"
else
    fail "Gateway NOT accessible (would break internet access!)"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 6: Persistence Check
# ============================================
print_test "6" "Persistence - Restart WITHOUT --no-network flag"

./scripts/calf-bootstrap --stop
sleep 2

info "Starting VM without --no-network flag (should auto-enable isolation)"
(sleep 8; echo "exit") | ./scripts/calf-bootstrap --run &
BOOTSTRAP_PID=$!

sleep 10
wait $BOOTSTRAP_PID 2>/dev/null || true

# Check that isolation is still active
output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
    admin@$(tart ip calf-dev) "curl -s --connect-timeout 5 http://192.168.1.1 2>&1 || echo 'STILL_BLOCKED'" 2>&1)

if echo "$output" | grep -q "STILL_BLOCKED"; then
    pass "Network isolation persisted across restart"
else
    fail "Network isolation did NOT persist"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 7: Re-enable Should Be No-op
# ============================================
print_test "7" "Re-enable Network Isolation (Should Be No-op)"

# Capture output before tmux starts
output=$( (sleep 8; echo "exit") | ./scripts/calf-bootstrap --restart --no-network 2>&1 &
BOOTSTRAP_PID=$!
sleep 10
wait $BOOTSTRAP_PID 2>/dev/null || true
)

if echo "$output" | grep -q "already enabled"; then
    pass "Re-enabling shows 'already enabled' message"
else
    fail "Re-enabling did not show 'already enabled'"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 8: Disable Network Isolation
# ============================================
print_test "8" "Disable Network Isolation"

./scripts/calf-bootstrap --stop
sleep 2

info "Running with --yes to skip confirmations"
echo ""

(sleep 8; echo "exit") | ./scripts/calf-bootstrap --run --no-network=false --yes &
BOOTSTRAP_PID=$!

sleep 10
wait $BOOTSTRAP_PID 2>/dev/null || true

# Check marker file removed
if [ ! -f ~/.calf-no-network ]; then
    pass "Network isolation marker file removed"
else
    fail "Network isolation marker file still exists"
fi

# Check status
output=$(./scripts/calf-bootstrap --status 2>&1)
if echo "$output" | grep -q "Network: Full access"; then
    pass "Status shows full network access"
else
    fail "Status does not show full access"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 9: Verify Full Network Access Restored
# ============================================
print_test "9" "Verify Full Network Access Restored"

vm_ip=$(tart ip calf-dev 2>/dev/null || echo "")
output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 \
    admin@$vm_ip "ping -c 1 192.168.64.1 >/dev/null 2>&1 && echo 'CAN_REACH' || echo 'BLOCKED'" 2>&1)

if echo "$output" | grep -q "CAN_REACH"; then
    pass "Host access restored (can reach host)"
else
    fail "Host access NOT restored"
    echo "Output: $output"
fi

wait_for_user

# ============================================
# Test 10: GUI Mode with Network Isolation
# ============================================
print_test "10" "GUI Mode with Network Isolation"

info "Skipping GUI mode test (requires manual VNC interaction)"
info "GUI mode uses same --net-softnet flag, so isolation works the same"

# Just verify the marker file logic from previous test
if [ -f ~/.calf-no-network ]; then
    fail "Network isolation marker should not exist (was disabled in Test 8)"
else
    pass "Network isolation correctly disabled from previous test"
fi

wait_for_user

# ============================================
# Test 11: --yes Flag Skips Prompts
# ============================================
print_test "11" "Test --yes Flag (Auto-confirm)"

info "Running with --yes flag (should not prompt)"
./scripts/calf-bootstrap --run --no-network --yes >/dev/null 2>&1 &
RUN_PID=$!

sleep 10

# Check if it started successfully
if [ -f ~/.calf-no-network ]; then
    pass "--yes flag skipped prompts and enabled isolation"
else
    fail "--yes flag did not work as expected"
fi

# ============================================
# Cleanup
# ============================================
print_test "CLEANUP" "Stopping VM and Restoring State"

./scripts/calf-bootstrap --stop 2>/dev/null || true
rm -f ~/.calf-no-network
sleep 2

info "Cleanup complete"

# ============================================
# Summary
# ============================================
echo ""
echo "${BLUE}╔════════════════════════════════════════════════╗${NC}"
echo "${BLUE}║  Test Summary                                  ║${NC}"
echo "${BLUE}╚════════════════════════════════════════════════╝${NC}"
echo ""
echo "Total Tests: $TESTS_RUN"
echo "${GREEN}Passed: $PASSED${NC}"
echo "${RED}Failed: $FAILED${NC}"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "${GREEN}╔════════════════════════════════════════════════╗${NC}"
    echo "${GREEN}║  ✓ ALL TESTS PASSED!                          ║${NC}"
    echo "${GREEN}╚════════════════════════════════════════════════╝${NC}"
    exit 0
else
    echo "${RED}╔════════════════════════════════════════════════╗${NC}"
    echo "${RED}║  ✗ SOME TESTS FAILED                           ║${NC}"
    echo "${RED}╚════════════════════════════════════════════════╝${NC}"
    exit 1
fi
